import { Callout } from 'nextra/components'

# Troubleshooting

This guide covers common issues you may encounter when using NovaPM and how to resolve them.

## Daemon Won't Start / Connection Refused

If you see `Error: connect ECONNREFUSED` when running NovaPM commands, the daemon is not running or is unreachable.

**Check if the daemon is running:**

```bash
nova-pm ping
```

**Force-restart the daemon:**

```bash
nova-pm daemon restart
```

**If the daemon fails to start**, check the daemon logs:

```bash
cat ~/.novapm/logs/daemon.log
```

<Callout type="info">
The daemon binds to `127.0.0.1:9876` by default. Ensure no other service is using that port.
</Callout>

**Common causes:**

- Another NovaPM instance is already running
- The socket file at `~/.novapm/nova-pm.sock` is stale -- remove it and restart
- Insufficient permissions to bind to the configured port

```bash
# Remove stale socket and restart
rm -f ~/.novapm/nova-pm.sock
nova-pm daemon start
```

## Process Crashes and Restart Loops

When a process keeps crashing and restarting, NovaPM applies exponential backoff automatically. However, if a process is stuck in a restart loop:

**Check the process logs:**

```bash
nova-pm logs <app-name> --lines 100
```

**Check restart count and status:**

```bash
nova-pm status
```

**Stop the restart loop temporarily:**

```bash
nova-pm stop <app-name>
```

<Callout type="warning">
If a process has restarted more than 15 times in quick succession, NovaPM will mark it as `errored` and stop attempting restarts. Use `nova-pm restart <app-name>` to reset the counter.
</Callout>

**Configure restart behavior in your config:**

```typescript
// nova-pm.config.ts
export default {
  apps: [{
    name: "my-app",
    script: "./app.js",
    max_restarts: 10,
    min_uptime: "5s",
    restart_delay: 4000,
  }]
}
```

## High Memory / CPU Usage

**Identify resource-heavy processes:**

```bash
nova-pm monit
```

**Set memory limits to auto-restart processes that exceed a threshold:**

```typescript
export default {
  apps: [{
    name: "my-app",
    script: "./app.js",
    max_memory_restart: "500M",
  }]
}
```

**For CPU issues**, check if you are running more instances than available CPU cores:

```bash
nova-pm scale my-app 4  # Match to your core count
```

<Callout type="info">
Use `nova-pm metrics <app-name>` to view historical CPU and memory trends and identify when spikes occur.
</Callout>

## Port Conflicts

If your application fails to start with `EADDRINUSE`:

**Find what is using the port:**

```bash
lsof -i :3000
```

**Use NovaPM's `increment_var` to auto-assign ports in cluster mode:**

```typescript
export default {
  apps: [{
    name: "my-app",
    script: "./app.js",
    instances: 4,
    increment_var: "PORT",
    env: {
      PORT: 3000  // Instances get 3000, 3001, 3002, 3003
    }
  }]
}
```

## Permission Issues

**Symptoms:** `EACCES` errors when starting processes or writing logs.

**Fix NOVA_HOME permissions:**

```bash
# Reset ownership of the NovaPM directory
sudo chown -R $(whoami) ~/.novapm
chmod -R 755 ~/.novapm
```

<Callout type="warning">
Never run NovaPM with `sudo` in production. Instead, fix the underlying permission issue or use a dedicated service user.
</Callout>

**For ports below 1024**, use a reverse proxy (like Nginx) instead of running NovaPM as root.

## Log File Issues

**Logs consuming too much disk space:**

```bash
# Check log sizes
du -sh ~/.novapm/logs/*

# Flush all logs
nova-pm flush

# Flush logs for a specific app
nova-pm flush <app-name>
```

**Configure log rotation in your config:**

```typescript
export default {
  apps: [{
    name: "my-app",
    script: "./app.js",
    log_date_format: "YYYY-MM-DD HH:mm:ss",
    max_log_size: "10M",
    retain_logs: 5,
    merge_logs: true,
  }]
}
```

**Redirect logs to custom paths:**

```typescript
export default {
  apps: [{
    name: "my-app",
    script: "./app.js",
    output_log: "/var/log/nova/my-app-out.log",
    error_log: "/var/log/nova/my-app-err.log",
  }]
}
```

## Database Corruption Recovery

NovaPM uses an internal database to track process state. If it becomes corrupted:

**Symptoms:** `nova-pm status` returns garbled data or errors, processes show incorrect state.

**Recovery steps:**

```bash
# Stop the daemon
nova-pm daemon stop

# Back up the corrupted database
cp ~/.novapm/db/nova-pm.db ~/.novapm/db/nova-pm.db.backup

# Remove the corrupted database
rm ~/.novapm/db/nova-pm.db

# Restart the daemon (a fresh database will be created)
nova-pm daemon start

# Re-register your applications
nova-pm start nova-pm.config.ts
```

<Callout type="warning">
This will reset all process metadata including restart counts and uptime history. Running processes are not affected and will be re-adopted by the new daemon.
</Callout>

## Common Error Messages

| Error Message | Cause | Solution |
|---|---|---|
| `ECONNREFUSED 127.0.0.1:9876` | Daemon not running | Run `nova-pm daemon start` |
| `EADDRINUSE :::3000` | Port already in use | Kill the conflicting process or change ports |
| `ENOMEM` | System out of memory | Reduce instances or set `max_memory_restart` |
| `EACCES /home/user/.novapm` | Permission denied | Fix ownership with `chown` |
| `Script not found` | Invalid script path in config | Verify the `script` path is correct and the file exists |
| `Maximum restart count reached` | Too many rapid restarts | Fix the root cause, then `nova-pm restart <app>` |
| `Database locked` | Concurrent daemon access | Stop all daemons and restart a single instance |

## Getting More Help

If your issue is not covered here:

1. Run `nova-pm report` to generate a diagnostic report
2. Check the [GitHub Issues](https://github.com/nova-pm/nova/issues) for known problems
3. Include daemon logs (`~/.novapm/logs/daemon.log`) when filing bug reports
